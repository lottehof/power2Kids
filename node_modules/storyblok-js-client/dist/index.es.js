/*!
 * storyblok-js-client v4.0.9
 * Universal JavaScript SDK for Storyblok's API
 * (c) 2020-2021 Stobylok Team
 */
import{stringify as t}from"qs";import e from"axios";function r(t){return"number"==typeof t&&(t==t&&t!==1/0&&t!==-1/0)}function s(t,e,s){if(!r(e))throw new TypeError("Expected `limit` to be a finite number");if(!r(s))throw new TypeError("Expected `interval` to be a finite number");var i=[],n=[],a=0,o=function(){a++;var e=setTimeout((function(){a--,i.length>0&&o(),n=n.filter((function(t){return t!==e}))}),s);n.indexOf(e)<0&&n.push(e);var r=i.shift();r.resolve(t.apply(r.self,r.args))},l=function(){var t=arguments,r=this;return new Promise((function(s,n){i.push({resolve:s,reject:n,args:t,self:r}),a<e&&o()}))};return l.abort=function(){n.forEach(clearTimeout),n=[],i.forEach((function(t){t.reject(new throttle.AbortError)})),i.length=0},l}s.AbortError=function(){Error.call(this,"Throttled function aborted"),this.name="AbortError"};const i=function(t,e){if(!t)return null;let r={};for(let s in t){let i=t[s];e.indexOf(s)>-1&&null!==i&&(r[s]=i)}return r};var n={nodes:{horizontal_rule:t=>({singleTag:"hr"}),blockquote:t=>({tag:"blockquote"}),bullet_list:t=>({tag:"ul"}),code_block:t=>({tag:["pre",{tag:"code",attrs:t.attrs}]}),hard_break:t=>({singleTag:"br"}),heading:t=>({tag:"h"+t.attrs.level}),image:t=>({singleTag:[{tag:"img",attrs:i(t.attrs,["src","alt","title"])}]}),list_item:t=>({tag:"li"}),ordered_list:t=>({tag:"ol"}),paragraph:t=>({tag:"p"})},marks:{bold:()=>({tag:"b"}),strike:()=>({tag:"strike"}),underline:()=>({tag:"u"}),strong:()=>({tag:"strong"}),code:()=>({tag:"code"}),italic:()=>({tag:"i"}),link(t){const e={...t.attrs},{linktype:r="url"}=t.attrs;return"email"===r&&(e.href="mailto:"+e.href),e.anchor&&(e.href=`${e.href}#${e.anchor}`,delete e.anchor),{tag:[{tag:"a",attrs:e}]}},styled:t=>({tag:[{tag:"span",attrs:t.attrs}]})}};class a{constructor(t){t||(t=n),this.marks=t.marks||[],this.nodes=t.nodes||[]}addNode(t,e){this.nodes[t]=e}addMark(t,e){this.marks[t]=e}render(t={}){if(t.content&&Array.isArray(t.content)){let e="";return t.content.forEach(t=>{e+=this.renderNode(t)}),e}return console.warn("The render method must receive an object with a content field, which is an array"),""}renderNode(t){let e=[];t.marks&&t.marks.forEach(t=>{const r=this.getMatchingMark(t);r&&e.push(this.renderOpeningTag(r.tag))});const r=this.getMatchingNode(t);return r&&r.tag&&e.push(this.renderOpeningTag(r.tag)),t.content?t.content.forEach(t=>{e.push(this.renderNode(t))}):t.text?e.push(function(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},r=/[&<>"']/g,s=RegExp(r.source);return t&&s.test(t)?t.replace(r,t=>e[t]):t}(t.text)):r&&r.singleTag?e.push(this.renderTag(r.singleTag," /")):r&&r.html&&e.push(r.html),r&&r.tag&&e.push(this.renderClosingTag(r.tag)),t.marks&&t.marks.slice(0).reverse().forEach(t=>{const r=this.getMatchingMark(t);r&&e.push(this.renderClosingTag(r.tag))}),e.join("")}renderTag(t,e){if(t.constructor===String)return`<${t}${e}>`;return t.map(t=>{if(t.constructor===String)return`<${t}${e}>`;{let r="<"+t.tag;if(t.attrs)for(let e in t.attrs){let s=t.attrs[e];null!==s&&(r+=` ${e}="${s}"`)}return`${r}${e}>`}}).join("")}renderOpeningTag(t){return this.renderTag(t,"")}renderClosingTag(t){if(t.constructor===String)return`</${t}>`;return t.slice(0).reverse().map(t=>t.constructor===String?`</${t}>`:`</${t.tag}>`).join("")}getMatchingNode(t){if("function"==typeof this.nodes[t.type])return this.nodes[t.type](t)}getMatchingMark(t){if("function"==typeof this.marks[t.type])return this.marks[t.type](t)}}const o=(t=0,e=t)=>{const r=Math.abs(e-t)||0,s=t<e?1:-1;return((t=0,e)=>[...Array(t)].map(e))(r,(e,r)=>r*s+t)};let l={},c={};export default class{constructor(t,r){if(!r){let e=t.region?"-"+t.region:"",s=!1===t.https?"http":"https";r=void 0===t.oauthToken?`${s}://api${e}.storyblok.com/v2`:`${s}://api${e}.storyblok.com/v1`}let i=Object.assign({},t.headers),n=5;void 0!==t.oauthToken&&(i.Authorization=t.oauthToken,n=3),void 0!==t.rateLimit&&(n=t.rateLimit),this.richTextResolver=new a(t.richTextSchema),"function"==typeof t.componentResolver&&this.setComponentResolver(t.componentResolver),this.maxRetries=t.maxRetries||5,this.throttle=s(this.throttledRequest,n,1e3),this.accessToken=t.accessToken,this.relations={},this.links={},this.cache=t.cache||{clear:"manual"},this.client=e.create({baseURL:r,timeout:t.timeout||0,headers:i,proxy:t.proxy||!1}),t.responseInterceptor&&this.client.interceptors.response.use(e=>t.responseInterceptor(e))}setComponentResolver(t){this.richTextResolver.addNode("blok",e=>{let r="";return e.attrs.body.forEach(e=>{r+=t(e.component,e)}),{html:r}})}parseParams(t={}){return t.version||(t.version="published"),t.token||(t.token=this.getToken()),t.cv||(t.cv=c[t.token]),Array.isArray(t.resolve_relations)&&(t.resolve_relations=t.resolve_relations.join(",")),t}factoryParamOptions(t,e={}){return((t="")=>t.indexOf("/cdn/")>-1)(t)?this.parseParams(e):e}makeRequest(t,e,r,s){const i=this.factoryParamOptions(t,((t={},e=25,r=1)=>({...t,per_page:e,page:r}))(e,r,s));return this.cacheResponse(t,i)}get(t,e){let r="/"+t;const s=this.factoryParamOptions(r,e);return this.cacheResponse(r,s)}async getAll(t,e={},r){const s=e.per_page||25,i="/"+t,n=i.split("/");r=r||n[n.length-1];const a=await this.makeRequest(i,e,s,1),l=Math.ceil(a.total/s);return((t=[],e)=>t.map(e).reduce((t,e)=>[...t,...e],[]))([a,...await(async(t=[],e)=>Promise.all(t.map(e)))(o(1,l),async t=>this.makeRequest(i,e,s,t+1))],t=>Object.values(t.data[r]))}post(t,e){let r="/"+t;return this.throttle("post",r,e)}put(t,e){let r="/"+t;return this.throttle("put",r,e)}delete(t,e){let r="/"+t;return this.throttle("delete",r,e)}getStories(t){return this.get("cdn/stories",t)}getStory(t,e){return this.get("cdn/stories/"+t,e)}setToken(t){this.accessToken=t}getToken(){return this.accessToken}_cleanCopy(t){return JSON.parse(JSON.stringify(t))}_insertLinks(t,e){const r=t[e];r&&"multilink"==r.fieldtype&&"story"==r.linktype&&"string"==typeof r.id&&this.links[r.id]&&(r.story=this._cleanCopy(this.links[r.id]))}_insertRelations(t,e,r){if(r.indexOf(t.component+"."+e)>-1)if("string"==typeof t[e])this.relations[t[e]]&&(t[e]=this._cleanCopy(this.relations[t[e]]));else if(t[e].constructor===Array){let r=[];t[e].forEach(t=>{this.relations[t]&&r.push(this._cleanCopy(this.relations[t]))}),t[e]=r}}iterateTree(t,e){let r=t=>{if(null!=t)if(t.constructor===Array)for(let e=0;e<t.length;e++)r(t[e]);else if(t.constructor===Object&&t.component&&t._uid)for(let s in t)this._insertRelations(t,s,e),this._insertLinks(t,s),r(t[s])};r(t.content)}async resolveLinks(t,e){let r=[];if(t.link_uuids){const s=t.link_uuids.length;let i=[];const n=50;for(let e=0;e<s;e+=n){const r=Math.min(s,e+n);i.push(t.link_uuids.slice(e,r))}for(let t=0;t<i.length;t++){(await this.getStories({per_page:n,version:e.version,by_uuids:i[t].join(",")})).data.stories.forEach(t=>{r.push(t)})}}else r=t.links;r.forEach(t=>{this.links[t.uuid]=t})}async resolveRelations(t,e){let r=[];if(t.rel_uuids){const s=t.rel_uuids.length;let i=[];const n=50;for(let e=0;e<s;e+=n){const r=Math.min(s,e+n);i.push(t.rel_uuids.slice(e,r))}for(let t=0;t<i.length;t++){(await this.getStories({per_page:n,version:e.version,by_uuids:i[t].join(",")})).data.stories.forEach(t=>{r.push(t)})}}else r=t.rels;r.forEach(t=>{this.relations[t.uuid]=t})}async resolveStories(t,e){let r=[];void 0!==e.resolve_relations&&e.resolve_relations.length>0&&(r=e.resolve_relations.split(","),await this.resolveRelations(t,e)),["1","story","url"].indexOf(e.resolve_links)>-1&&await this.resolveLinks(t,e);for(const t in this.relations)this.iterateTree(this.relations[t],r);t.story?this.iterateTree(t.story,r):t.stories.forEach(t=>{this.iterateTree(t,r)})}cacheResponse(e,r,s){return void 0===s&&(s=0),new Promise(async(i,n)=>{let a=t({url:e,params:r},{arrayFormat:"brackets"}),o=this.cacheProvider();if("auto"===this.cache.clear&&"draft"===r.version&&await this.flushCache(),"published"===r.version&&"/cdn/spaces/me"!=e){const t=await o.get(a);if(t)return i(t)}try{let s=await this.throttle("get",e,{params:r,paramsSerializer:e=>t(e,{arrayFormat:"brackets"})}),l={data:s.data,headers:s.headers};if(s.headers["per-page"]&&(l=Object.assign({},l,{perPage:parseInt(s.headers["per-page"]),total:parseInt(s.headers.total)})),200!=s.status)return n(s);(l.data.story||l.data.stories)&&await this.resolveStories(l.data,r),"published"===r.version&&"/cdn/spaces/me"!=e&&o.set(a,l),l.data.cv&&("draft"==r.version&&c[r.token]!=l.data.cv&&this.flushCache(),c[r.token]=l.data.cv),i(l)}catch(t){if(t.response&&429===t.response.status&&(s+=1)<this.maxRetries)return console.log(`Hit rate limit. Retrying in ${s} seconds.`),await(l=1e3*s,new Promise(t=>setTimeout(t,l))),this.cacheResponse(e,r,s).then(i).catch(n);n(t)}var l})}throttledRequest(t,e,r){return this.client[t](e,r)}cacheVersions(){return c}cacheVersion(){return c[this.accessToken]}setCacheVersion(t){this.accessToken&&(c[this.accessToken]=t)}cacheProvider(){switch(this.cache.type){case"memory":return{get:t=>l[t],getAll:()=>l,set(t,e){l[t]=e},flush(){l={}}};default:return{get(){},getAll(){},set(){},flush(){}}}}async flushCache(){return await this.cacheProvider().flush(),this}}
